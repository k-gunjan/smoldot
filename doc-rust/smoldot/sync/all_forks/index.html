<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="All-forks header and body syncing."><meta name="keywords" content="rust, rustlang, rust-lang, all_forks"><title>smoldot::sync::all_forks - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../smoldot/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../smoldot/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module all_forks</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#reexports">Re-exports</a></li><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../smoldot/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">smoldot</a>::<wbr><a href="../index.html">sync</a>::<wbr><a class="mod" href="#">all_forks</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/smoldot/sync/all_forks.rs.html#18-2211">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p><em>All-forks</em> header and body syncing.</p>
<h2 id="overview"><a href="#overview">Overview</a></h2>
<p>This state machine holds:</p>
<ul>
<li>A list of sources of blocks, maintained by the API user.</li>
<li>For each source, a list of blocks hashes known by the source.</li>
<li>The latest known finalized block.</li>
<li>A tree of valid non-finalized blocks that all descend from the latest known finalized block.</li>
<li>(if full mode) A list of block headers whose body is currently being downloaded.</li>
<li>A list of block header waiting to be verified and whose ancestry with the latest finalized
block is currently unknown.</li>
</ul>
<p>The state machine has the objective to synchronize the tree of non-finalized blocks with its
equivalent on the sources added by the API user.</p>
<p>Because it is not possible to predict which block in this tree is going to be finalized in
the future, the entire tree needs to be synchronized.</p>
<blockquote>
<p><strong>Example</strong>: If the latest finalized block is block number 4, and the tree contains blocks
5, 6, and 7, and a source announces a block 5 that is different from the
locally-known block 5, a block request will be emitted for this block 5, even
if it is certain that this “other” block 5 will not become the local best
block. This is necessary in case it is this other block 5 that will end up
being finalized.</p>
</blockquote>
<h2 id="full-vs-non-full"><a href="#full-vs-non-full">Full vs non-full</a></h2>
<p>The <a href="struct.Config.html#structfield.full" title="Config::full"><code>Config::full</code></a> option configures whether the state machine only holds headers of the
non-finalized blocks (<code>full</code> equal to <code>false</code>), or the headers, and bodies, and storage
(<code>full</code> equal to <code>true</code>).</p>
<p>In full mode, .</p>
<h2 id="bounded-and-unbounded-containers"><a href="#bounded-and-unbounded-containers">Bounded and unbounded containers</a></h2>
<p>It is important to limit the memory usage of this state machine no matter how the
potentially-malicious sources behave.</p>
<p>The state in this state machine can be put into three categories:</p>
<ul>
<li>
<p>Each source of blocks has a certain fixed-size state associated to it (containing for
instance its best block number and height). Each source also has up to one in-flight
request, which might incur more memory usage. Managing this additional request is out of
scope of this module. The user of this module is expected to limit the number of
simultaneous sources.</p>
</li>
<li>
<p>A set of verified blocks that descend from the latest finalized block. This set is
unbounded. The consensus and finalization algorithms of the chain are supposed to limit
the number of possible blocks in this set.</p>
</li>
<li>
<p>A set of blocks that can’t be verified yet. Receiving a block announce inserts an element
in this set. In order to handle situations where a malicious source announces lots of
invalid blocks, this set must be bounded. Once it has reached a certain size, the blocks
with the highest block number are discarded if their parent is also in this set or being
downloaded from a source.</p>
</li>
</ul>
<p>Consequently, and assuming that the number of simultaneous sources is bounded, and that
the consensus and finalization algorithms of the chain are properly configured, malicious
sources can’t indefinitely grow the state in this state machine.
Malicious sources, however, can potentially increase the number of block requests required to
download a long fork. This is, at most, an annoyance, and not a vulnerability.</p>
</div></details><h2 id="reexports" class="small-section-header"><a href="#reexports">Re-exports</a></h2><div class="item-table"><div class="item-row"><div class="item-left import-item" id="reexport.SourceId"><code>pub use pending_blocks::<a class="struct" href="sources/struct.SourceId.html" title="struct smoldot::sync::all_forks::sources::SourceId">SourceId</a>;</code></div></div></div><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="sources/index.html" title="smoldot::sync::all_forks::sources mod">sources</a></div><div class="item-right docblock-short">Collection of sources used for the <code>all_forks</code> syncing.</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AddBlockOccupied.html" title="smoldot::sync::all_forks::AddBlockOccupied struct">AddBlockOccupied</a></div><div class="item-right docblock-short">See <a href="struct.FinishAncestrySearch.html#method.add_block" title="FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a> and <a href="enum.AddBlock.html" title="AddBlock"><code>AddBlock</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AddBlockVacant.html" title="smoldot::sync::all_forks::AddBlockVacant struct">AddBlockVacant</a></div><div class="item-right docblock-short">See <a href="struct.FinishAncestrySearch.html#method.add_block" title="FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a> and <a href="enum.AddBlock.html" title="AddBlock"><code>AddBlock</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AddSourceKnown.html" title="smoldot::sync::all_forks::AddSourceKnown struct">AddSourceKnown</a></div><div class="item-right docblock-short">See <a href="enum.AddSource.html" title="AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AddSourceOldBlock.html" title="smoldot::sync::all_forks::AddSourceOldBlock struct">AddSourceOldBlock</a></div><div class="item-right docblock-short">See <a href="enum.AddSource.html" title="AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AddSourceUnknown.html" title="smoldot::sync::all_forks::AddSourceUnknown struct">AddSourceUnknown</a></div><div class="item-right docblock-short">See <a href="enum.AddSource.html" title="AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AllForksSync.html" title="smoldot::sync::all_forks::AllForksSync struct">AllForksSync</a></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AnnouncedBlockKnown.html" title="smoldot::sync::all_forks::AnnouncedBlockKnown struct">AnnouncedBlockKnown</a></div><div class="item-right docblock-short">See <a href="enum.BlockAnnounceOutcome.html" title="BlockAnnounceOutcome"><code>BlockAnnounceOutcome</code></a> and <a href="struct.AllForksSync.html#method.block_announce" title="AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AnnouncedBlockUnknown.html" title="smoldot::sync::all_forks::AnnouncedBlockUnknown struct">AnnouncedBlockUnknown</a></div><div class="item-right docblock-short">See <a href="enum.BlockAnnounceOutcome.html" title="BlockAnnounceOutcome"><code>BlockAnnounceOutcome</code></a> and <a href="struct.AllForksSync.html#method.block_announce" title="AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Config.html" title="smoldot::sync::all_forks::Config struct">Config</a></div><div class="item-right docblock-short">Configuration for the <a href="struct.AllForksSync.html" title="AllForksSync"><code>AllForksSync</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.FinalityProofVerify.html" title="smoldot::sync::all_forks::FinalityProofVerify struct">FinalityProofVerify</a></div><div class="item-right docblock-short">Finality proof verification to be performed.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.FinishAncestrySearch.html" title="smoldot::sync::all_forks::FinishAncestrySearch struct">FinishAncestrySearch</a></div><div class="item-right docblock-short">See <a href="struct.AllForksSync.html#method.finish_ancestry_search" title="AllForksSync::finish_ancestry_search"><code>AllForksSync::finish_ancestry_search</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.HeaderVerify.html" title="smoldot::sync::all_forks::HeaderVerify struct">HeaderVerify</a></div><div class="item-right docblock-short">Header verification to be performed.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RequestId.html" title="smoldot::sync::all_forks::RequestId struct">RequestId</a></div><div class="item-right docblock-short">Identifier for a request in the <a href="struct.AllForksSync.html" title="super::AllForksSync"><code>super::AllForksSync</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RequestParams.html" title="smoldot::sync::all_forks::RequestParams struct">RequestParams</a></div><div class="item-right docblock-short">Information about a blocks request to be performed on a source.</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.AddBlock.html" title="smoldot::sync::all_forks::AddBlock enum">AddBlock</a></div><div class="item-right docblock-short">Result of calling <a href="struct.FinishAncestrySearch.html#method.add_block" title="FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.AddSource.html" title="smoldot::sync::all_forks::AddSource enum">AddSource</a></div><div class="item-right docblock-short">Outcome of calling <a href="struct.AllForksSync.html#method.prepare_add_source" title="AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.AncestrySearchResponseError.html" title="smoldot::sync::all_forks::AncestrySearchResponseError enum">AncestrySearchResponseError</a></div><div class="item-right docblock-short">Error when adding a block using <a href="struct.FinishAncestrySearch.html#method.add_block" title="FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.BlockAnnounceOutcome.html" title="smoldot::sync::all_forks::BlockAnnounceOutcome enum">BlockAnnounceOutcome</a></div><div class="item-right docblock-short">Outcome of calling <a href="struct.AllForksSync.html#method.block_announce" title="AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.BlockBodyVerify.html" title="smoldot::sync::all_forks::BlockBodyVerify enum">BlockBodyVerify</a></div><div class="item-right docblock-short">State of the processing of blocks.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.FinalityProofVerifyOutcome.html" title="smoldot::sync::all_forks::FinalityProofVerifyOutcome enum">FinalityProofVerifyOutcome</a></div><div class="item-right docblock-short">Information about the outcome of verifying a finality proof.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.GrandpaCommitMessageOutcome.html" title="smoldot::sync::all_forks::GrandpaCommitMessageOutcome enum">GrandpaCommitMessageOutcome</a></div><div class="item-right docblock-short">See <a href="struct.AllForksSync.html#method.grandpa_commit_message" title="AllForksSync::grandpa_commit_message"><code>AllForksSync::grandpa_commit_message</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.HeaderVerifyError.html" title="smoldot::sync::all_forks::HeaderVerifyError enum">HeaderVerifyError</a></div><div class="item-right docblock-short">Error that can happen when verifying a block header.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.HeaderVerifyOutcome.html" title="smoldot::sync::all_forks::HeaderVerifyOutcome enum">HeaderVerifyOutcome</a></div><div class="item-right docblock-short">Outcome of calling <a href="struct.HeaderVerify.html#method.perform" title="HeaderVerify::perform"><code>HeaderVerify::perform</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.ProcessOne.html" title="smoldot::sync::all_forks::ProcessOne enum">ProcessOne</a></div><div class="item-right docblock-short">State of the processing of blocks.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="smoldot" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>